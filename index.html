<!-- Version 1.01 - Grammar Gallery -->
<!-- Changes: -->
<!-- 1. Fixed "Let's Go!" button (now closes tutorial reliably) -->
<!-- 2. Changed title and text from "Toolkit" to "Grammar Gallery" -->
<!-- 3. Gallery wall only left/right, 130px thumbnails, no overlap -->
<!-- 4. Adjective puzzle accepts both "red" and "fast" -->
<!-- 5. All images load with correct filenames -->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grammar Gallery</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
  position: relative;
}
.game-container {
  max-width: 900px;
  width: 100%;
  background: white;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  overflow: hidden;
  position: relative;
  z-index: 10;
}
/* Gallery Wall - Only left and right */
.gallery-wall {
  position: absolute;
  top: 0; left: -20px; right: -20px; bottom: 0;
  pointer-events: none;
  z-index: 5;
}
.wall-left, .wall-right {
  position: absolute; top: 0; bottom: 0; width: 150px;
  display: flex; flex-direction: column; justify-content: space-around; align-items: center; padding: 20px 0;
}
.wall-left { left: 0; }
.wall-right { right: 0; }
.frame {
  width: 130px; height: 130px;
  background: #fff; border: 4px solid #764ba2; border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  overflow: hidden; cursor: pointer; pointer-events: auto;
  transition: transform 0.3s;
}
.frame:hover { transform: scale(1.1); }
.frame img { width: 100%; height: 100%; object-fit: cover; }
.frame.empty {
  background: #e7f3ff; display: flex; align-items: center; justify-content: center;
  color: #667eea; font-size: 12px; text-align: center;
}
/* Reward Popup */
.reward-box {
  background: white; padding: 30px; border-radius: 20px; max-width: 600px;
  text-align: center; max-height: 80vh; overflow-y: auto;
}
.reward-img {
  max-width: 100%; max-height: 50vh; object-fit: contain; border-radius: 10px; margin-bottom: 20px;
  cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.instruction {
  font-size: 18px; font-weight: bold; color: #667eea; margin: 20px 0;
}
/* Header */
.header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white; padding: 25px 30px;
}
.level-badge {
  display: inline-block; background: rgba(255,255,255,0.2);
  padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: bold;
  margin-bottom: 10px;
}
.concept-title { font-size: 28px; font-weight: bold; margin-bottom: 10px; }
.mission-text { font-size: 16px; opacity: 0.95; line-height: 1.4; }
/* Stats bar */
.stats-bar {
  display: flex; justify-content: space-between; align-items: center;
  padding: 20px 30px; background: #f8f9fa; border-bottom: 2px solid #e9ecef;
}
.stat { display: flex; align-items: center; gap: 8px; font-weight: 600; }
.stat-value { font-size: 24px; color: #667eea; }
.streak { color: #ff6b6b; }
.streak.active { animation: pulse 0.5s ease-in-out; }
@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
.progress-bar-container { flex: 1; margin: 0 30px; height: 12px; background: #dee2e6; border-radius: 10px; overflow: hidden; position: relative; }
.progress-bar { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.5s ease; border-radius: 10px; }
.progress-text { position: absolute; width: 100%; text-align: center; font-size: 11px; font-weight: bold; color: #495057; line-height: 12px; }
/* Main content */
.content { padding: 30px; }
.prompt { background: #e7f3ff; border-left: 4px solid #667eea; padding: 20px; margin-bottom: 25px; border-radius: 8px; font-size: 18px; font-weight: 600; color: #2c3e50; }
.sentence-display { background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px; font-size: 22px; line-height: 1.6; text-align: center; min-height: 80px; display: flex; align-items: center; justify-content: center; border: 2px dashed #dee2e6; }
.word-bank { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 25px; min-height: 100px; justify-content: center; }
.word-btn { padding: 12px 20px; border: 2px solid #dee2e6; background: white; border-radius: 8px; font-size: 18px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
.word-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.word-btn.selected { border-color: #667eea; background: #e7f3ff; transform: scale(1.05); }
.word-btn.verb { border-color: #ff6b6b; }
.word-btn.verb.selected { background: #ffe0e0; border-color: #ff6b6b; }
.word-btn.subject { border-color: #4ecdc4; }
.word-btn.subject.selected { background: #d4f4f1; border-color: #4ecdc4; }
.word-btn.adjective { border-color: #ffa500; }
.word-btn.adjective.selected { background: #fff5e0; border-color: #ffa500; }
.word-btn:disabled { opacity: 0.3; cursor: not-allowed; }
.selection-display { background: white; border: 2px solid #667eea; border-radius: 12px; padding: 20px; margin-bottom: 25px; min-height: 80px; font-size: 20px; text-align: center; display: flex; align-items: center; justify-content: center; color: #495057; }
.selection-display.empty { color: #adb5bd; font-style: italic; }
.choices { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
.choice-btn { padding: 18px; background: white; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px; cursor: pointer; transition: all 0.2s; font-weight: 500; text-align: center; }
.choice-btn:hover { border-color: #667eea; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.choice-btn.selected { border-color: #667eea; background: #e7f3ff; transform: scale(1.02); }
.feedback { padding: 20px; border-radius: 10px; margin-bottom: 25px; font-size: 16px; line-height: 1.5; min-height: 60px; display: flex; align-items: center; gap: 12px; font-weight: 500; }
.feedback.correct { background: #d4edda; border: 2px solid #28a745; color: #155724; }
.feedback.incorrect { background: #f8d7da; border: 2px solid #dc3545; color: #721c24; }
.feedback.neutral { background: #fff3cd; border: 2px solid #ffc107; color: #856404; }
.feedback.hidden { display: none; }
.controls { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
.btn { padding: 14px 28px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
.btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
.tutorial-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
.tutorial-box { background: white; padding: 40px; border-radius: 20px; max-width: 600px; text-align: center; }
.tutorial-box.gallery-box { max-height: 80vh; overflow-y: auto; }
.tutorial-box h2 { color: #667eea; margin-bottom: 20px; font-size: 32px; }
.tutorial-box p { margin-bottom: 15px; line-height: 1.6; font-size: 16px; color: #495057; }
.completion-screen { text-align: center; padding: 40px; }
.completion-screen h2 { font-size: 48px; color: #667eea; margin-bottom: 20px; }
.completion-screen .trophy { font-size: 80px; margin-bottom: 20px; animation: bounce 1s infinite; }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
.completion-stats { background: #f8f9fa; padding: 30px; border-radius: 12px; margin: 30px 0; display: inline-block; text-align: left; }
.completion-stats p { margin: 10px 0; font-size: 18px; font-weight: 500; }
.skills-unlocked { background: #e7f3ff; padding: 20px; border-radius: 12px; margin-top: 20px; }
.skills-unlocked h3 { color: #667eea; margin-bottom: 15px; }
.skills-unlocked ul { list-style: none; text-align: left; }
.skills-unlocked li { padding: 8px 0; font-size: 16px; }
.skills-unlocked li::before { content: "‚úì "; color: #28a745; font-weight: bold; margin-right: 8px; }
@keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
.word-btn { animation: slideIn 0.3s ease-out; }
.celebration { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 100px; z-index: 999; pointer-events: none; animation: celebrate 1s ease-out; }
@keyframes celebrate { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1) translateY(-100px); } }
@media (max-width: 600px) {
  .stats-bar { flex-direction: column; gap: 15px; }
  .progress-bar-container { margin: 0; width: 100%; }
  .concept-title { font-size: 22px; }
  .word-btn { font-size: 16px; padding: 10px 16px; }
  .wall-left, .wall-right { width: 100px; }
  .frame { width: 90px; height: 90px; }
}
.bridge { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px 20px; margin-bottom: 25px; border-radius: 8px; font-size: 14px; line-height: 1.5; color: #856404; }
.bridge strong { color: #533f03; }
</style>
</head>
<body>

<!-- Gallery Wall - Only left and right -->
<div class="gallery-wall" id="galleryWall">
  <div class="wall-left" id="wallLeft"></div>
  <div class="wall-right" id="wallRight"></div>
</div>

<div class="game-container" id="gameContainer">
  <div class="header">
    <div class="level-badge" id="levelBadge">Level 1</div>
    <div class="concept-title" id="conceptTitle">Find the VERB</div>
    <div class="mission-text" id="missionText">Click the verb to find the heartbeat of the sentence.</div>
  </div>
  <div class="stats-bar">
    <div class="stat"><span>‚≠ê</span><span class="stat-value" id="scoreValue">0</span></div>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      <div class="progress-text" id="progressText">0/22</div>
    </div>
    <div class="stat"><span>üî•</span><span class="stat-value streak" id="streakValue">0</span></div>
  </div>
  <div class="content" id="content">
    <div class="bridge" id="bridge"></div>
    <div class="prompt" id="prompt"></div>
    <div class="sentence-display" id="sentenceDisplay"></div>
    <div class="word-bank" id="wordBank"></div>
    <div class="selection-display empty" id="selectionDisplay">Click words to select them</div>
    <div class="choices" id="choices"></div>
    <div class="feedback hidden" id="feedback"></div>
    <div class="controls">
      <button class="btn btn-primary" id="checkBtn">Check Answer</button>
      <button class="btn btn-success" id="nextBtn" disabled>Next ‚Üí</button>
      <button class="btn btn-secondary" id="resetBtn">Reset</button>
      <button class="btn btn-warning" id="hintBtn">üí° Hint</button>
      <button class="btn btn-danger" id="skipBtn">Skip (Bug?)</button>
    </div>
  </div>
</div>

<!-- Tutorial overlay -->
<div class="tutorial-overlay" id="tutorialOverlay">
  <div class="tutorial-box">
    <h2>üõ†Ô∏è Welcome to Grammar Gallery!</h2>
    <p><strong>Your Mission:</strong> Train your brain to spot grammar patterns FAST‚Äîthe superpower you need for reading Spanish.</p>
    <p>üìù <strong>How it works:</strong> Click words in the scrambled Word Bank to select them. Click again to deselect.</p>
    <p>üéØ <strong>Why scrambled?</strong> So you focus on MEANING, not position‚Äîjust like real reading!</p>
    <p>üî• <strong>Build streaks</strong> for bonus points. Get 3+ correct in a row to activate multipliers!</p>
    <p>Ready to unlock your Spanish grammar gallery?</p>
    <button class="btn btn-primary" id="startBtn">Let's Go! üöÄ</button>
  </div>
</div>

<script>
// Version 1.01 - Grammar Gallery

// Game Data
const LEVELS = [
  {id:1, concept:"üîç Find the VERB", mission:"Click the verb.", bridge:"Spanish verbs pack WHO + WHEN.", colorClass:"verb", puzzles:[
    {type:"selectWords", prompt:"Select the VERB.", sentence:"She studies Spanish at night.", accept:[["studies"]], explain:"'studies' is the action."},
    {type:"selectWords", prompt:"Select the VERB.", sentence:"The store closes at eight.", accept:[["closes"]], explain:"'closes' is what the store does."},
    {type:"selectWords", prompt:"Select the VERB (linking).", sentence:"They are ready for the exam.", accept:[["are"]], explain:"'are' links subject to description."}
  ]},
  {id:2, concept:"üë§ Find the SUBJECT", mission:"Click the subject.", bridge:"Spanish often drops the subject.", colorClass:"subject", puzzles:[
    {type:"selectWords", prompt:"Select the SUBJECT.", sentence:"The happy student studies Spanish.", accept:[["student"], ["the","happy","student"]], explain:"Core subject = 'student'."},
    {type:"selectWords", prompt:"Select the SUBJECT.", sentence:"In the library, my friends read quietly.", accept:[["friends"], ["my","friends"]], explain:"Subject = 'my friends'."},
    {type:"selectWords", prompt:"Select the SUBJECT.", sentence:"Maria and Luis practice every day.", accept:[["maria","and","luis"]], explain:"Compound subject."}
  ]},
  {id:3, concept:"üè∑Ô∏è Tag Questions ‚Üí Pronouns", mission:"Choose the correct tag.", bridge:"Tag questions reveal pronouns.", colorClass:"", puzzles:[
    {type:"mc", prompt:"Choose tag:", stem:"Natalie is a student, _____?", options:["isn't she","aren't they","doesn't she"], answerIndex:0, explain:"Natalie ‚Üí she."},
    {type:"mc", prompt:"Choose tag:", stem:"The store closes at eight, _____?", options:["doesn't it","isn't it","don't they"], answerIndex:0, explain:"Store ‚Üí it."}
  ]},
  {id:4, concept:"üîÑ Replace with Pronouns", mission:"Swap nouns for pronouns.", bridge:"Spanish drops pronouns.", colorClass:"", puzzles:[
    {type:"mc", prompt:"Replace subject:", stem:"John studies Spanish. ‚Üí _____ studies Spanish.", options:["He","She","It","They"], answerIndex:0, explain:"John ‚Üí He."},
    {type:"mc", prompt:"Replace subject:", stem:"Maria and Luis practice. ‚Üí _____ practice.", options:["They","We","She","He"], answerIndex:0, explain:"Two people ‚Üí They."}
  ]},
  {id:5, concept:"‚öñÔ∏è Subject-Verb Agreement", mission:"Fix agreement error.", bridge:"Spanish agreement is strict.", colorClass:"", puzzles:[
    {type:"fix", prompt:"Fix agreement:", sentence:"The students studies Spanish.", choices:["study","studies"], answerIndex:0, explain:"Plural ‚Üí 'study'."},
    {type:"fix", prompt:"Fix agreement:", sentence:"He walk to class every day.", choices:["walk","walks"], answerIndex:1, explain:"Singular ‚Üí 'walks'."}
  ]},
  {id:6, concept:"‚è∞ Verb Tense Matching", mission:"Fix tense mismatch.", bridge:"Spanish encodes time in verb.", colorClass:"", puzzles:[
    {type:"fix", prompt:"Fix tense:", sentence:"Yesterday, she walks to class.", choices:["walked","walks"], answerIndex:0, explain:"Past ‚Üí 'walked'."},
    {type:"fix", prompt:"Fix tense:", sentence:"Tomorrow, we practiced.", choices:["will practice","practiced"], answerIndex:0, explain:"Future ‚Üí 'will practice'."}
  ]},
  {id:7, concept:"üé® Adjectives + Spanish Order", mission:"Find adjectives, use noun + adj.", bridge:"Spanish: noun before adjective.", colorClass:"adjective", puzzles:[
    {type:"selectWords", prompt:"Select the ADJECTIVE that describes the car.", sentence:"The red car is fast.", accept:[["red"],["fast"]], explain:"'red' and 'fast' are adjectives."},
    {type:"reorder", prompt:"Build in Spanish order (article + noun + adjective):", bank:["rojo (red)", "coche (car)", "el (the)"], answers:[["el (the)", "coche (car)", "rojo (red)"]], explain:"Spanish: el coche rojo (the red car). Noun comes before adjective!"}
  ]},
  {id:8, concept:"üö´ Possession: NO Apostrophe-S!", mission:"Rewrite using 'of' instead of apostrophe-s.", bridge:"Spanish uses 'de' (of), never apostrophe-s.", colorClass:"", puzzles:[
    {type:"mc", prompt:"Rewrite without apostrophe-s:", stem:"John's book ‚Üí", options:["the book of John","the John's book","Johns book"], answerIndex:0, explain:"'the book of John' matches Spanish logic."},
    {type:"reorder", prompt:"Build the Spanish phrase:", bank:["de (of)", "Juan (John)", "libro (book)", "el (the)"], answers:[["el (the)", "libro (book)", "de (of)", "juan (john)"]], explain:"Spanish: el libro de Juan (the book of John)."},
    {type:"mc", prompt:"Rewrite without apostrophe-s:", stem:"Lisa's car ‚Üí", options:["the car of Lisa","Lisas car","the Lisa car"], answerIndex:0, explain:"'the car of Lisa' ‚Üí Spanish: el coche de Lisa."}
  ]}
];
const TOTAL_PUZZLES = LEVELS.reduce((sum, l) => sum + l.puzzles.length, 0);

const REWARDS = [
  {image:'persistencia.jpg', artist:'Salvador Dal√≠', title:'The Persistence of Memory', blurb:'This iconic surrealist work depicts melting clocks in a barren landscape, symbolizing the fluidity of time. To tell real paintings from AI-generated ones, look for the artist\'s unique brushwork and subtle textures that come from physical paint application, which AI simulations often lack in authenticity.'},
  {image:'goya.jpg', artist:'Francisco Goya', title:'Saturn Devouring His Son', blurb:'A dark and haunting depiction from Goya\'s Black Paintings series, showing the Titan Saturn consuming his child. Real artworks like this have provenance and material analysis that confirm authenticity, whereas AI-generated images may have digital artifacts or inconsistent anatomical details.'},
  {image:'ledesma.jpg', artist:'Clara Ledesma', title:'Untitled', blurb:'An abstract work by the Dominican artist, featuring vibrant colors and forms. To differentiate from AI, note the organic imperfections and personal style evolution in the artist\'s oeuvre, which AI struggles to mimic consistently.'},
  {image:'elgreco.jpg', artist:'El Greco', title:'Portrait of Cardinal Fernando Ni√±o de Guevara', blurb:'This Mannerist portrait captures the inquisitor with elongated figures and dramatic lighting. Authentic paintings show layers of paint and craquelure from age, unlike smooth, flawless AI outputs.'},
  {image:'velazquez.jpg', artist:'Diego Vel√°zquez', title:'Las Meninas', blurb:'A complex Baroque composition depicting the Spanish royal family and their attendants. Real vs. AI: Examine the masterful use of light and shadow, and the physical canvas texture visible in high-resolution scans.'},
  {image:'diegorivera.jpg', artist:'Diego Rivera', title:'Sue√±o de una Tarde Dominical en la Alameda Central', blurb:'A mural depicting Mexican history and figures in a dreamlike park setting. To spot AI fakes, check for historical accuracy in details and the artist\'s signature style, as AI may introduce anachronisms or stylistic inconsistencies.'},
  {image:'frida.jpg', artist:'Frida Kahlo', title:'Las Dos Fridas', blurb:'This self-portrait shows two versions of Frida connected by veins, symbolizing her heritage and pain. Real paintings have tangible evidence like X-rays showing underdrawings, which AI cannot replicate.'},
  {image:'wilfredolam.jpg', artist:'Wilfredo Lam', title:'La Jungla', blurb:'A Cubist-inspired work blending Afro-Cuban elements with jungle motifs. Distinguishing from AI: Look for the fusion of cultural influences that reflect the artist\'s life, often mishandled in AI generations due to lack of contextual understanding.'}
];

// State
let levelIndex = 0, puzzleIndex = 0, score = 0, streak = 0, completedPuzzles = 0, startTime = Date.now(), endTime;
let selectedIds = new Set(), currentTokens = [], scrambleOrder = [], chosenIndex = null, builtOrder = [], unlockedPaintings = [];

// Elements
const els = {
  levelBadge: document.getElementById('levelBadge'),
  conceptTitle: document.getElementById('conceptTitle'),
  missionText: document.getElementById('missionText'),
  bridge: document.getElementById('bridge'),
  prompt: document.getElementById('prompt'),
  sentenceDisplay: document.getElementById('sentenceDisplay'),
  wordBank: document.getElementById('wordBank'),
  selectionDisplay: document.getElementById('selectionDisplay'),
  choices: document.getElementById('choices'),
  feedback: document.getElementById('feedback'),
  scoreValue: document.getElementById('scoreValue'),
  streakValue: document.getElementById('streakValue'),
  progressBar: document.getElementById('progressBar'),
  progressText: document.getElementById('progressText'),
  checkBtn: document.getElementById('checkBtn'),
  nextBtn: document.getElementById('nextBtn'),
  resetBtn: document.getElementById('resetBtn'),
  hintBtn: document.getElementById('hintBtn'),
  skipBtn: document.getElementById('skipBtn'),
  gameContainer: document.getElementById('gameContainer'),
  tutorialOverlay: document.getElementById('tutorialOverlay'),
  wallLeft: document.getElementById('wallLeft'),
  wallRight: document.getElementById('wallRight')
};

// Helpers
function currentLevel() { return LEVELS[levelIndex]; }
function currentPuzzle() { return currentLevel().puzzles[puzzleIndex]; }
function tokenize(s) { 
  const parts = s.replace(/([,.!?;:])/g, " $1 ").replace(/\s+/g, " ").trim().split(" ");
  return parts.map((t,i) => ({id:`t${i}_${Math.random().toString(16).slice(2)}`, text:t, norm:t.toLowerCase(), rawIndex:i}));
}
function normalizeTokens(t) {
  const noSpace = new Set([",",".","!","?",";",":"]);
  let out = "";
  t.forEach((tok,i) => {
    const text = typeof tok === "string" ? tok : tok.text;
    if (i === 0) out += text;
    else if (noSpace.has(text)) out += text;
    else out += " " + text;
  });
  return out.trim();
}
function shuffleArray(a) {
  const arr = a.slice();
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function multiset(arr) {
  const m = new Map();
  arr.forEach(x => m.set(x, (m.get(x) || 0) + 1));
  return m;
}
function multisetsEqual(a, b) {
  if (a.size !== b.size) return false;
  for (const [k,v] of a) if (b.get(k) !== v) return false;
  return true;
}
function updateStats() {
  els.scoreValue.textContent = score;
  els.streakValue.textContent = streak;
  els.streakValue.classList.toggle('active', streak >= 3);
  const progress = (completedPuzzles / TOTAL_PUZZLES) * 100;
  els.progressBar.style.width = progress + '%';
  els.progressText.textContent = `${completedPuzzles}/${TOTAL_PUZZLES}`;
}
function showFeedback(msg, type) {
  els.feedback.textContent = msg;
  els.feedback.className = `feedback ${type}`;
  els.feedback.classList.remove('hidden');
}
function hideFeedback() { els.feedback.classList.add('hidden'); }
function celebrate() {
  const emojis = ['üéâ','‚ú®','üåü','üí´','üéä'];
  const cel = document.createElement('div');
  cel.className = 'celebration';
  cel.textContent = emojis[Math.floor(Math.random()*5)];
  document.body.appendChild(cel);
  setTimeout(() => cel.remove(), 1000);
}

// Render
function renderHeader() {
  const lvl = currentLevel();
  els.levelBadge.textContent = `Level ${lvl.id}/${LEVELS.length}`;
  els.conceptTitle.textContent = lvl.concept;
  els.missionText.textContent = lvl.mission;
  els.bridge.textContent = lvl.bridge;
}
function renderPuzzle() {
  const p = currentPuzzle(), lvl = currentLevel();
  els.prompt.textContent = p.prompt;
  els.wordBank.innerHTML = '';
  els.choices.innerHTML = '';
  els.sentenceDisplay.textContent = '';
  selectedIds.clear(); chosenIndex = null; builtOrder = []; currentTokens = []; scrambleOrder = [];
  hideFeedback(); els.nextBtn.disabled = true;

  if (p.type === 'selectWords') renderSelectWords(p, lvl.colorClass);
  else if (p.type === 'mc') renderMultipleChoice(p);
  else if (p.type === 'fix') renderFix(p);
  else if (p.type === 'reorder') renderReorder(p);

  updateSelectionDisplay();
}
function renderSelectWords(p, cls) {
  els.sentenceDisplay.textContent = p.sentence;
  if (currentTokens.length === 0) {
    currentTokens = tokenize(p.sentence);
    scrambleOrder = shuffleArray(currentTokens.map(t => t.id));
  }
  scrambleOrder.forEach(id => {
    const tok = currentTokens.find(t => t.id === id);
    const btn = document.createElement('button');
    btn.className = `word-btn ${cls}`;
    btn.textContent = tok.text;
    btn.onclick = () => {
      selectedIds.has(tok.id) ? selectedIds.delete(tok.id) : selectedIds.add(tok.id);
      updateWordButtons();
      updateSelectionDisplay();
    };
    if (selectedIds.has(tok.id)) btn.classList.add('selected');
    els.wordBank.appendChild(btn);
  });
}
function updateWordButtons() {
  els.wordBank.querySelectorAll('.word-btn').forEach(btn => {
    const tok = currentTokens.find(t => t.text === btn.textContent);
    btn.classList.toggle('selected', tok && selectedIds.has(tok.id));
  });
}
function renderMultipleChoice(p) {
  els.sentenceDisplay.textContent = p.stem;
  p.options.forEach((opt,i) => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = opt;
    if (chosenIndex === i) btn.classList.add('selected');
    btn.onclick = () => {
      chosenIndex = i;
      renderMultipleChoice(p);
      updateSelectionDisplay();
    };
    els.choices.appendChild(btn);
  });
}
function renderFix(p) {
  els.sentenceDisplay.textContent = p.sentence;
  p.choices.forEach((opt,i) => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = opt;
    if (chosenIndex === i) btn.classList.add('selected');
    btn.onclick = () => {
      chosenIndex = i;
      renderFix(p);
      updateSelectionDisplay();
    };
    els.choices.appendChild(btn);
  });
}
function renderReorder(p) {
  els.sentenceDisplay.textContent = "Build the phrase in the correct order:";
  shuffleArray(p.bank.slice()).forEach(w => {
    const btn = document.createElement('button');
    btn.className = 'word-btn';
    btn.textContent = w;
    btn.onclick = () => {
      builtOrder.push(w);
      updateSelectionDisplay();
    };
    els.wordBank.appendChild(btn);
  });
}
function updateSelectionDisplay() {
  const p = currentPuzzle();
  if (p.type === 'selectWords') {
    if (selectedIds.size === 0) {
      els.selectionDisplay.className = 'selection-display empty';
      els.selectionDisplay.textContent = 'Click words to select them';
    } else {
      els.selectionDisplay.className = 'selection-display';
      const picked = currentTokens.filter(t => selectedIds.has(t.id)).sort((a,b) => a.rawIndex - b.rawIndex).map(t => t.text);
      els.selectionDisplay.textContent = `Your selection: ${normalizeTokens(picked)}`;
    }
  } else if (p.type === 'reorder') {
    if (builtOrder.length === 0) {
      els.selectionDisplay.className = 'selection-display empty';
      els.selectionDisplay.textContent = 'Click words to build the phrase';
    } else {
      els.selectionDisplay.className = 'selection-display';
      els.selectionDisplay.textContent = normalizeTokens(builtOrder);
    }
  } else if (p.type === 'mc' || p.type === 'fix') {
    if (chosenIndex === null) {
      els.selectionDisplay.className = 'selection-display empty';
      els.selectionDisplay.textContent = 'Choose an option above';
    } else {
      els.selectionDisplay.className = 'selection-display';
      els.selectionDisplay.textContent = `Your choice: ${p.choices ? p.choices[chosenIndex] : p.options[chosenIndex]}`;
    }
  }
}

// Checking
function checkAnswer() {
  const p = currentPuzzle();
  if (p.type === 'selectWords') checkSelectWords();
  else if (p.type === 'mc' || p.type === 'fix') checkChoice();
  else if (p.type === 'reorder') checkReorder();
}
function checkSelectWords() {
  const p = currentPuzzle();
  const picked = currentTokens.filter(t => selectedIds.has(t.id)).sort((a,b) => a.rawIndex - b.rawIndex).map(t => t.norm);
  const correct = (p.accept || []).some(set => multisetsEqual(multiset(picked), multiset(set.map(w => String(w).toLowerCase()))));
  correct ? handleCorrect(p.explain) : handleIncorrect("Not quite! Try again.");
}
function checkChoice() {
  const p = currentPuzzle();
  if (chosenIndex === null) return showFeedback("Select an option first!", 'neutral');
  chosenIndex === p.answerIndex ? handleCorrect(p.explain) : handleIncorrect("Not quite! Try again.");
}
function checkReorder() {
  const p = currentPuzzle();
  const built = builtOrder.map(w => String(w).toLowerCase()).join(" ");
  const correct = (p.answers || []).some(ans => ans.map(w => String(w).toLowerCase()).join(" ") === built);
  correct ? handleCorrect(p.explain) : handleIncorrect("Not quite! Reset and try again.");
}
function handleCorrect(explain) {
  const points = 5 + Math.min(streak, 10);
  score += points; streak++; completedPuzzles++;
  updateStats(); celebrate();
  showFeedback(`‚úÖ Correct! +${points} points ${explain}`, 'correct');
  els.nextBtn.disabled = false;
}
function handleIncorrect(msg) {
  streak = 0; updateStats();
  showFeedback(`‚ùå ${msg}`, 'incorrect');
}

// Controls
function reset() { renderPuzzle(); }
function showHint() { showFeedback(`üí° ${currentLevel().bridge}`, 'neutral'); }
function skip() {
  showFeedback('‚è≠Ô∏è Skipped. No points.', 'neutral');
  streak = 0; completedPuzzles++; updateStats();
  setTimeout(next, 1000);
}
function next() {
  const lvl = currentLevel();
  if (puzzleIndex < lvl.puzzles.length - 1) {
    puzzleIndex++;
    renderPuzzle();
    hideFeedback();
  } else {
    // Level complete ‚Üí show reward
    const reward = REWARDS[levelIndex];
    unlockedPaintings.push(reward);
    showReward(levelIndex + 1, reward);
  }
}
function showReward(levelId, reward) {
  const overlay = document.createElement('div');
  overlay.className = 'tutorial-overlay';
  overlay.innerHTML = `
    <div class="reward-box">
      <h2>üé® Level ${levelId} Reward!</h2>
      <img src="${reward.image}" alt="${reward.title}" class="reward-img">
      <p><strong>${reward.artist} - ${reward.title}</strong></p>
      <p>${reward.blurb}</p>
      <p class="instruction">Click the painting to hang it in your gallery and continue!</p>
    </div>
  `;
  document.body.appendChild(overlay);

  // Click the image to close and proceed
  overlay.querySelector('.reward-img').onclick = () => {
    overlay.remove();
    renderGalleryWall(); // Update wall after click
    if (levelIndex < LEVELS.length - 1) {
      levelIndex++;
      puzzleIndex = 0;
      renderHeader();
      renderPuzzle();
      hideFeedback();
    } else {
      endTime = Date.now();
      showCompletion();
    }
  };
}
function renderGalleryWall() {
  const sides = {
    left: els.wallLeft,
    right: els.wallRight
  };
  Object.values(sides).forEach(el => el.innerHTML = '');
  const framesPerSide = 4; // 4 on left, 4 on right
  ['left', 'right'].forEach((sideKey, sideIndex) => {
    const el = sides[sideKey];
    for (let j = 0; j < framesPerSide; j++) {
      const i = sideIndex * framesPerSide + j;
      const r = unlockedPaintings[i];
      const frame = document.createElement('div');
      frame.className = 'frame';
      if (r) {
        frame.innerHTML = `<img src="${r.image}" alt="${r.title}">`;
        frame.onclick = () => showReward(i+1, r);
      } else {
        frame.className += ' empty';
        frame.textContent = 'Empty';
      }
      el.appendChild(frame);
    }
  });
}
function showCompletion() {
  const totalTime = Math.floor((endTime - startTime) / 60000);
  const code = `GG-${LEVELS.length}-${score}-${Math.floor(Math.random() * 9000 + 1000)}`;

  els.gameContainer.innerHTML = `
    <div class="completion-screen">
      <div class="trophy">üèÜ</div>
      <h2>Grammar Gallery Complete!</h2>
      <p style="font-size:20px;color:#495057;margin-bottom:30px;">You've unlocked your Grammar Gallery!</p>
      <div class="completion-stats">
        <p>‚≠ê Final Score: <strong>${score}</strong></p>
        <p>üî• Best Streak: <strong>${Math.max(streak,0)}</strong></p>
        <p>üìä Puzzles Completed: <strong>${TOTAL_PUZZLES}/${TOTAL_PUZZLES}</strong></p>
        <p>‚è±Ô∏è Time Taken: <strong>${totalTime} minutes</strong></p>
        <p>üéØ Verification Code: <strong>${code}</strong></p>
      </div>
      <div class="skills-unlocked">
        <h3>üõ†Ô∏è Skills Mastered:</h3>
        <ul>
          <li>Find verbs FAST</li>
          <li>Identify subjects</li>
          <li>Tag questions ‚Üí pronouns</li>
          <li>Subject-verb agreement</li>
          <li>Tense matching</li>
          <li>Spanish adjective order</li>
          <li>Possession with 'de'</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="showGallery()" style="margin-top:20px;">View Your Gallery üñºÔ∏è</button>
      <button class="btn btn-primary" onclick="location.reload()" style="margin-top:20px;">Play Again</button>
    </div>
  `;
}
function showGallery() {
  const totalTime = Math.floor((endTime - startTime) / 60000);
  const code = `GG-${LEVELS.length}-${score}-${Math.floor(Math.random() * 9000 + 1000)}`;
  const recap = `Score: ${score}\nTime Taken: ${totalTime} minutes\nVerification Code: ${code}\n\nCopy and post this to the VHL site exercise.`;

  const overlay = document.createElement('div');
  overlay.className = 'tutorial-overlay';
  overlay.innerHTML = `
    <div class="tutorial-box gallery-box">
      <h2>Your Grammar Gallery</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:20px 0;">
        ${unlockedPaintings.map((r,i) => `
          <div style="background:white;padding:15px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1);text-align:center;">
            <img src="${r.image}" alt="${r.title}" style="max-width:100%;max-height:400px;object-fit:contain;border-radius:10px;margin-bottom:10px;">
            <p><strong>${r.artist} - ${r.title}</strong></p>
            <p>${r.blurb}</p>
          </div>
        `).join('')}
      </div>
      <h3>Recap for Professor</h3>
      <textarea id="recapText" style="width:100%;height:100px;padding:10px;">${recap}</textarea>
      <button class="btn btn-primary" onclick="copyRecap()" style="margin-top:10px;">Copy Recap</button>
      <p>Copy the above and post to the VHL site exercise.</p>
      <button class="btn btn-primary" onclick="this.parentNode.parentNode.remove()" style="margin-top:10px;">Close</button>
    </div>
  `;
  document.body.appendChild(overlay);
}
function copyRecap() {
  const recapText = document.getElementById('recapText');
  recapText.select();
  document.execCommand('copy');
  alert('Recap copied to clipboard!');
}
function closeTutorial() {
  document.getElementById('tutorialOverlay').style.display = 'none';
}

// Event Listeners
els.checkBtn.onclick = checkAnswer;
els.nextBtn.onclick = next;
els.resetBtn.onclick = reset;
els.hintBtn.onclick = showHint;
els.skipBtn.onclick = skip;
document.getElementById('startBtn').onclick = closeTutorial;
document.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    if (!els.nextBtn.disabled) next();
    else checkAnswer();
  }
});

// Init
function init() {
  unlockedPaintings = [];
  startTime = Date.now();
  renderHeader();
  renderPuzzle();
  updateStats();
  renderGalleryWall();
}
init();
</script>
</body>
</html>
