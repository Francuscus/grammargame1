<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sentence Detective: Spanish Prep Edition</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.game-container {
  max-width: 900px;
  width: 100%;
  background: white;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  overflow: hidden;
}

/* Header */
.header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 25px 30px;
  position: relative;
}

.level-badge {
  display: inline-block;
  background: rgba(255,255,255,0.2);
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: bold;
  margin-bottom: 10px;
}

.concept-title {
  font-size: 28px;
  font-weight: bold;
  margin-bottom: 10px;
}

.mission-text {
  font-size: 16px;
  opacity: 0.95;
  line-height: 1.4;
}

/* Stats bar */
.stats-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 30px;
  background: #f8f9fa;
  border-bottom: 2px solid #e9ecef;
}

.stat {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
}

.stat-value {
  font-size: 24px;
  color: #667eea;
}

.streak {
  color: #ff6b6b;
}

.streak.active {
  animation: pulse 0.5s ease-in-out;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}

.progress-bar-container {
  flex: 1;
  margin: 0 30px;
  height: 12px;
  background: #dee2e6;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  transition: width 0.5s ease;
  border-radius: 10px;
}

.progress-text {
  position: absolute;
  width: 100%;
  text-align: center;
  font-size: 11px;
  font-weight: bold;
  color: #495057;
  line-height: 12px;
}

/* Main content */
.content {
  padding: 30px;
}

.prompt {
  background: #e7f3ff;
  border-left: 4px solid #667eea;
  padding: 20px;
  margin-bottom: 25px;
  border-radius: 8px;
  font-size: 18px;
  font-weight: 600;
  color: #2c3e50;
}

.sentence-display {
  background: #f8f9fa;
  padding: 25px;
  border-radius: 12px;
  margin-bottom: 25px;
  font-size: 22px;
  line-height: 1.6;
  text-align: center;
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px dashed #dee2e6;
}

.word-bank {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 25px;
  min-height: 100px;
  justify-content: center;
}

.word-btn {
  padding: 12px 20px;
  border: 2px solid #dee2e6;
  background: white;
  border-radius: 8px;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
}

.word-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.word-btn.selected {
  border-color: #667eea;
  background: #e7f3ff;
  transform: scale(1.05);
}

.word-btn.verb { border-color: #ff6b6b; }
.word-btn.verb.selected { background: #ffe0e0; border-color: #ff6b6b; }

.word-btn.subject { border-color: #4ecdc4; }
.word-btn.subject.selected { background: #d4f4f1; border-color: #4ecdc4; }

.word-btn.adjective { border-color: #ffa500; }
.word-btn.adjective.selected { background: #fff5e0; border-color: #ffa500; }

.word-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

/* Selection display */
.selection-display {
  background: white;
  border: 2px solid #667eea;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 25px;
  min-height: 80px;
  font-size: 20px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #495057;
}

.selection-display.empty {
  color: #adb5bd;
  font-style: italic;
}

/* Choices (MC/Fix) */
.choices {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 25px;
}

.choice-btn {
  padding: 18px;
  background: white;
  border: 2px solid #dee2e6;
  border-radius: 10px;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
  text-align: center;
}

.choice-btn:hover {
  border-color: #667eea;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.choice-btn.selected {
  border-color: #667eea;
  background: #e7f3ff;
  transform: scale(1.02);
}

/* Feedback */
.feedback {
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 25px;
  font-size: 16px;
  line-height: 1.5;
  min-height: 60px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 500;
}

.feedback.correct {
  background: #d4edda;
  border: 2px solid #28a745;
  color: #155724;
}

.feedback.incorrect {
  background: #f8d7da;
  border: 2px solid #dc3545;
  color: #721c24;
}

.feedback.neutral {
  background: #fff3cd;
  border: 2px solid #ffc107;
  color: #856404;
}

.feedback.hidden {
  display: none;
}

.feedback-icon {
  font-size: 24px;
}

/* Controls */
.controls {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: center;
}

.btn {
  padding: 14px 28px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-success {
  background: #28a745;
  color: white;
}

.btn-warning {
  background: #ffc107;
  color: #333;
}

.btn-danger {
  background: #dc3545;
  color: white;
}

/* Tutorial overlay */
.tutorial-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  padding: 20px;
}

.tutorial-box {
  background: white;
  padding: 40px;
  border-radius: 20px;
  max-width: 600px;
  text-align: center;
}

.tutorial-box h2 {
  color: #667eea;
  margin-bottom: 20px;
  font-size: 32px;
}

.tutorial-box p {
  margin-bottom: 15px;
  line-height: 1.6;
  font-size: 16px;
  color: #495057;
}

.tutorial-box .btn {
  margin-top: 20px;
}

/* Completion screen */
.completion-screen {
  text-align: center;
  padding: 40px;
}

.completion-screen h2 {
  font-size: 48px;
  color: #667eea;
  margin-bottom: 20px;
}

.completion-screen .trophy {
  font-size: 80px;
  margin-bottom: 20px;
  animation: bounce 1s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-20px); }
}

.completion-stats {
  background: #f8f9fa;
  padding: 30px;
  border-radius: 12px;
  margin: 30px 0;
  display: inline-block;
  text-align: left;
}

.completion-stats p {
  margin: 10px 0;
  font-size: 18px;
  font-weight: 500;
}

.skills-unlocked {
  background: #e7f3ff;
  padding: 20px;
  border-radius: 12px;
  margin-top: 20px;
}

.skills-unlocked h3 {
  color: #667eea;
  margin-bottom: 15px;
}

.skills-unlocked ul {
  list-style: none;
  text-align: left;
}

.skills-unlocked li {
  padding: 8px 0;
  font-size: 16px;
}

.skills-unlocked li::before {
  content: "‚úì ";
  color: #28a745;
  font-weight: bold;
  margin-right: 8px;
}

/* Animations */
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.word-btn {
  animation: slideIn 0.3s ease-out;
}

.celebration {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 100px;
  z-index: 999;
  pointer-events: none;
  animation: celebrate 1s ease-out;
}

@keyframes celebrate {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0);
  }
  50% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.2);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(1) translateY(-100px);
  }
}

/* Responsive */
@media (max-width: 600px) {
  .stats-bar {
    flex-direction: column;
    gap: 15px;
  }
  
  .progress-bar-container {
    margin: 0;
    width: 100%;
  }
  
  .concept-title {
    font-size: 22px;
  }
  
  .word-btn {
    font-size: 16px;
    padding: 10px 16px;
  }
}

/* Bridge info */
.bridge {
  background: #fff3cd;
  border-left: 4px solid #ffc107;
  padding: 15px 20px;
  margin-bottom: 25px;
  border-radius: 8px;
  font-size: 14px;
  line-height: 1.5;
  color: #856404;
}

.bridge strong {
  color: #533f03;
}
</style>
</head>
<body>

<div class="game-container" id="gameContainer">
  <!-- Header -->
  <div class="header">
    <div class="level-badge" id="levelBadge">Level 1</div>
    <div class="concept-title" id="conceptTitle">Find the VERB</div>
    <div class="mission-text" id="missionText">Click the verb to find the heartbeat of the sentence.</div>
  </div>

  <!-- Stats -->
  <div class="stats-bar">
    <div class="stat">
      <span>‚≠ê</span>
      <span class="stat-value" id="scoreValue">0</span>
    </div>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      <div class="progress-text" id="progressText">0/24</div>
    </div>
    <div class="stat">
      <span>üî•</span>
      <span class="stat-value streak" id="streakValue">0</span>
    </div>
  </div>

  <!-- Content -->
  <div class="content" id="content">
    <div class="bridge" id="bridge"></div>
    <div class="prompt" id="prompt"></div>
    <div class="sentence-display" id="sentenceDisplay"></div>
    <div class="word-bank" id="wordBank"></div>
    <div class="selection-display empty" id="selectionDisplay">Click words to select them</div>
    <div class="choices" id="choices"></div>
    <div class="feedback hidden" id="feedback"></div>
    <div class="controls">
      <button class="btn btn-primary" id="checkBtn">Check Answer</button>
      <button class="btn btn-success" id="nextBtn" disabled>Next ‚Üí</button>
      <button class="btn btn-secondary" id="resetBtn">Reset</button>
      <button class="btn btn-warning" id="hintBtn">üí° Hint</button>
      <button class="btn btn-danger" id="skipBtn">Skip (Bug?)</button>
    </div>
  </div>
</div>

<!-- Tutorial overlay -->
<div class="tutorial-overlay" id="tutorialOverlay">
  <div class="tutorial-box">
    <h2>üîç Welcome, Detective!</h2>
    <p><strong>Your Mission:</strong> Train your brain to spot grammar patterns FAST‚Äîthe superpower you need for reading Spanish.</p>
    <p>üìù <strong>How it works:</strong> Click words in the scrambled Word Bank to select them. Click again to deselect.</p>
    <p>üéØ <strong>Why scrambled?</strong> So you focus on MEANING, not position‚Äîjust like real reading!</p>
    <p>üî• <strong>Build streaks</strong> for bonus points. Get 3+ correct in a row to activate multipliers!</p>
    <p>Ready to unlock your Spanish reading toolkit?</p>
    <button class="btn btn-primary" onclick="closeTutorial()">Let's Go! üöÄ</button>
  </div>
</div>

<script>
// ===========================
// GAME DATA
// ===========================

const LEVELS = [
  {
    id: 1,
    concept: "üîç Find the VERB (the heartbeat)",
    mission: "Click the verb. Every sentence needs one!",
    bridge: "Spanish verbs pack WHO + WHEN into one word. Find the verb = unlock the sentence.",
    colorClass: "verb",
    puzzles: [
      {
        type: "selectWords",
        prompt: "Select the VERB.",
        sentence: "She studies Spanish at night.",
        accept: [["studies"]],
        explain: "'studies' is the action‚Äîthe heartbeat of the sentence."
      },
      {
        type: "selectWords",
        prompt: "Select the VERB.",
        sentence: "The store closes at eight.",
        accept: [["closes"]],
        explain: "'closes' is what the store does."
      },
      {
        type: "selectWords",
        prompt: "Select the VERB (linking verb).",
        sentence: "They are ready for the exam.",
        accept: [["are"]],
        explain: "'are' links the subject to a description."
      }
    ]
  },
  {
    id: 2,
    concept: "üë§ Find the SUBJECT (who's doing it?)",
    mission: "Click the subject‚Äîthe person or thing doing the verb.",
    bridge: "Spanish often drops the subject word, but it still exists. You're training that logic now.",
    colorClass: "subject",
    puzzles: [
      {
        type: "selectWords",
        prompt: "Select the SUBJECT.",
        sentence: "The happy student studies Spanish.",
        accept: [["student"], ["the", "happy", "student"]],
        explain: "Core subject = 'student'. Full phrase = 'the happy student'."
      },
      {
        type: "selectWords",
        prompt: "Select the SUBJECT (don't get fooled!).",
        sentence: "In the library, my friends read quietly.",
        accept: [["friends"], ["my", "friends"]],
        explain: "Subject = 'my friends'. 'In the library' is just location info."
      },
      {
        type: "selectWords",
        prompt: "Select the SUBJECT.",
        sentence: "Maria and Luis practice every day.",
        accept: [["maria", "and", "luis"], ["maria"], ["luis"]],
        explain: "'Maria and Luis' is a compound subject."
      }
    ]
  },
  {
    id: 3,
    concept: "üè∑Ô∏è Tag Questions ‚Üí Pronouns",
    mission: "Choose the correct tag ending. This reveals the pronoun!",
    bridge: "Tag questions force you to identify the subject. Spanish verb endings do the same job.",
    colorClass: "",
    puzzles: [
      {
        type: "mc",
        prompt: "Choose the best tag ending:",
        stem: "Natalie is a student, _____?",
        options: ["isn't she", "aren't they", "doesn't she"],
        answerIndex: 0,
        explain: "Natalie ‚Üí she. 'is' ‚Üí isn't she."
      },
      {
        type: "mc",
        prompt: "Choose the best tag ending:",
        stem: "The store closes at eight, _____?",
        options: ["doesn't it", "isn't it", "don't they"],
        answerIndex: 0,
        explain: "The store ‚Üí it. Present simple ‚Üí doesn't it."
      }
    ]
  },
  {
    id: 4,
    concept: "üîÑ Replace with Pronouns",
    mission: "Swap proper nouns for pronouns (he, she, it, they, we).",
    bridge: "Spanish can drop pronouns entirely‚Äîbut you need to know which one the verb implies.",
    colorClass: "",
    puzzles: [
      {
        type: "mc",
        prompt: "Replace the subject:",
        stem: "John studies Spanish. ‚Üí _____ studies Spanish.",
        options: ["He", "She", "It", "They"],
        answerIndex: 0,
        explain: "John ‚Üí He."
      },
      {
        type: "mc",
        prompt: "Replace the subject:",
        stem: "Maria and Luis practice. ‚Üí _____ practice.",
        options: ["They", "We", "She", "He"],
        answerIndex: 0,
        explain: "Two people ‚Üí They."
      }
    ]
  },
  {
    id: 5,
    concept: "‚öñÔ∏è Subject-Verb Agreement",
    mission: "Fix the agreement error. The subject and verb must match!",
    bridge: "Spanish agreement is even stricter. Master this now, dominate Spanish later.",
    colorClass: "",
    puzzles: [
      {
        type: "fix",
        prompt: "Fix the agreement error:",
        sentence: "The students studies Spanish.",
        choices: ["study", "studies"],
        answerIndex: 0,
        explain: "'students' is plural ‚Üí 'study' (no -s)."
      },
      {
        type: "fix",
        prompt: "Fix the agreement error:",
        sentence: "He walk to class every day.",
        choices: ["walk", "walks"],
        answerIndex: 1,
        explain: "'he' is singular ‚Üí 'walks' (add -s)."
      }
    ]
  },
  {
    id: 6,
    concept: "‚è∞ Verb Tense Matching",
    mission: "Fix tense mismatches. Time words must match the verb!",
    bridge: "Spanish encodes time INSIDE the verb ending. This trains your timing instincts.",
    colorClass: "",
    puzzles: [
      {
        type: "fix",
        prompt: "Fix the tense mismatch:",
        sentence: "Yesterday, she walks to class.",
        choices: ["walked", "walks"],
        answerIndex: 0,
        explain: "'Yesterday' = past ‚Üí 'walked'."
      },
      {
        type: "fix",
        prompt: "Fix the tense mismatch:",
        sentence: "Tomorrow, we practiced.",
        choices: ["will practice", "practiced"],
        answerIndex: 0,
        explain: "'Tomorrow' = future ‚Üí 'will practice'."
      }
    ]
  },
  {
    id: 7,
    concept: "üé® Adjectives + Spanish Order",
    mission: "Find adjectives, then practice Spanish word order (noun + adjective).",
    bridge: "Spanish flips it: 'red car' becomes 'coche rojo' (car red). Get used to it now!",
    colorClass: "adjective",
    puzzles: [
      {
        type: "selectWords",
        prompt: "Select the ADJECTIVE.",
        sentence: "The red car is fast.",
        accept: [["red"]],
        explain: "'red' describes the car. Spanish: el coche rojo."
      },
      {
        type: "reorder",
        prompt: "Build in Spanish order (article + noun + adjective):",
        bank: ["rojo", "coche", "el"],
        answers: [["el", "coche", "rojo"]],
        explain: "Spanish: el coche rojo (noun + adjective)."
      }
    ]
  },
  {
    id: 8,
    concept: "üö´ Possession: NO Apostrophe-S!",
    mission: "Rewrite using 'of' instead of apostrophe-s. Spanish does the same!",
    bridge: "Spanish uses 'de' (of), never apostrophe-s. John's book = el libro DE Juan.",
    colorClass: "",
    puzzles: [
      {
        type: "mc",
        prompt: "Rewrite without apostrophe-s:",
        stem: "John's book ‚Üí",
        options: ["the book of John", "the John's book", "Johns book"],
        answerIndex: 0,
        explain: "'the book of John' matches Spanish logic."
      },
      {
        type: "reorder",
        prompt: "Build the Spanish phrase:",
        bank: ["de", "Juan", "libro", "el"],
        answers: [["el", "libro", "de", "juan"]],
        explain: "Spanish: el libro de Juan (the book of John)."
      },
      {
        type: "mc",
        prompt: "Rewrite without apostrophe-s:",
        stem: "Lisa's car ‚Üí",
        options: ["the car of Lisa", "Lisas car", "the Lisa car"],
        answerIndex: 0,
        explain: "'the car of Lisa' ‚Üí Spanish: el coche de Lisa."
      }
    ]
  }
];

// Calculate total puzzles
const TOTAL_PUZZLES = LEVELS.reduce((sum, level) => sum + level.puzzles.length, 0);

// ===========================
// STATE
// ===========================

let levelIndex = 0;
let puzzleIndex = 0;
let score = 0;
let streak = 0;
let completedPuzzles = 0;

let selectedIds = new Set();
let currentTokens = [];
let scrambleOrder = [];
let chosenIndex = null;
let builtOrder = [];

// ===========================
// ELEMENTS
// ===========================

const els = {
  levelBadge: document.getElementById('levelBadge'),
  conceptTitle: document.getElementById('conceptTitle'),
  missionText: document.getElementById('missionText'),
  bridge: document.getElementById('bridge'),
  prompt: document.getElementById('prompt'),
  sentenceDisplay: document.getElementById('sentenceDisplay'),
  wordBank: document.getElementById('wordBank'),
  selectionDisplay: document.getElementById('selectionDisplay'),
  choices: document.getElementById('choices'),
  feedback: document.getElementById('feedback'),
  scoreValue: document.getElementById('scoreValue'),
  streakValue: document.getElementById('streakValue'),
  progressBar: document.getElementById('progressBar'),
  progressText: document.getElementById('progressText'),
  checkBtn: document.getElementById('checkBtn'),
  nextBtn: document.getElementById('nextBtn'),
  resetBtn: document.getElementById('resetBtn'),
  hintBtn: document.getElementById('hintBtn'),
  skipBtn: document.getElementById('skipBtn'),
  gameContainer: document.getElementById('gameContainer'),
  tutorialOverlay: document.getElementById('tutorialOverlay')
};

// ===========================
// HELPERS
// ===========================

function currentLevel() {
  return LEVELS[levelIndex];
}

function currentPuzzle() {
  return currentLevel().puzzles[puzzleIndex];
}

function tokenize(sentence) {
  const parts = sentence
    .replace(/([,.!?;:])/g, " $1 ")
    .replace(/\s+/g, " ")
    .trim()
    .split(" ");
  
  return parts.map((t, i) => ({
    id: `t${i}_${Math.random().toString(16).slice(2)}`,
    text: t,
    norm: t.toLowerCase(),
    rawIndex: i
  }));
}

function normalizeTokens(tokens) {
  const noSpaceBefore = new Set([",", ".", "!", "?", ";", ":"]);
  let out = "";
  tokens.forEach((t, i) => {
    const tok = typeof t === "string" ? t : t.text;
    if (i === 0) { out += tok; return; }
    if (noSpaceBefore.has(tok)) out += tok;
    else out += " " + tok;
  });
  return out.trim();
}

function shuffleArray(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function multiset(arr) {
  const m = new Map();
  for (const x of arr) m.set(x, (m.get(x) || 0) + 1);
  return m;
}

function multisetsEqual(a, b) {
  if (a.size !== b.size) return false;
  for (const [k, v] of a.entries()) {
    if (b.get(k) !== v) return false;
  }
  return true;
}

function updateStats() {
  els.scoreValue.textContent = score;
  els.streakValue.textContent = streak;
  
  if (streak >= 3) {
    els.streakValue.classList.add('active');
  } else {
    els.streakValue.classList.remove('active');
  }
  
  const progress = (completedPuzzles / TOTAL_PUZZLES) * 100;
  els.progressBar.style.width = progress + '%';
  els.progressText.textContent = `${completedPuzzles}/${TOTAL_PUZZLES}`;
}

function showFeedback(message, type) {
  els.feedback.textContent = message;
  els.feedback.className = `feedback ${type}`;
  els.feedback.classList.remove('hidden');
}

function hideFeedback() {
  els.feedback.classList.add('hidden');
}

function celebrate() {
  const emoji = ['üéâ', '‚ú®', 'üåü', 'üí´', 'üéä'][Math.floor(Math.random() * 5)];
  const cel = document.createElement('div');
  cel.className = 'celebration';
  cel.textContent = emoji;
  document.body.appendChild(cel);
  setTimeout(() => cel.remove(), 1000);
}

// ===========================
// RENDER
// ===========================

function renderHeader() {
  const level = currentLevel();
  els.levelBadge.textContent = `Level ${level.id}/${LEVELS.length}`;
  els.conceptTitle.textContent = level.concept;
  els.missionText.textContent = level.mission;
  els.bridge.textContent = level.bridge;
}

function renderPuzzle() {
  const puzzle = currentPuzzle();
  const level = currentLevel();
  
  els.prompt.textContent = puzzle.prompt;
  
  // Clear previous state
  els.wordBank.innerHTML = '';
  els.choices.innerHTML = '';
  els.sentenceDisplay.textContent = '';
  selectedIds.clear();
  chosenIndex = null;
  builtOrder = [];
  currentTokens = [];
  scrambleOrder = [];
  
  hideFeedback();
  els.nextBtn.disabled = true;
  
  // Render based on type
  if (puzzle.type === 'selectWords') {
    renderSelectWords(puzzle, level.colorClass);
  } else if (puzzle.type === 'mc') {
    renderMultipleChoice(puzzle);
  } else if (puzzle.type === 'fix') {
    renderFix(puzzle);
  } else if (puzzle.type === 'reorder') {
    renderReorder(puzzle);
  }
  
  updateSelectionDisplay();
}

function renderSelectWords(puzzle, colorClass) {
  els.sentenceDisplay.textContent = puzzle.sentence;
  
  // Only tokenize and scramble once per puzzle
  if (currentTokens.length === 0) {
    currentTokens = tokenize(puzzle.sentence);
    scrambleOrder = shuffleArray(currentTokens.map(t => t.id));
  }
  
  // Clear and rebuild word bank
  els.wordBank.innerHTML = '';
  
  scrambleOrder.forEach(id => {
    const tok = currentTokens.find(t => t.id === id);
    const btn = document.createElement('button');
    btn.className = `word-btn ${colorClass}`;
    btn.textContent = tok.text;
    
    btn.onclick = () => {
      if (selectedIds.has(tok.id)) {
        selectedIds.delete(tok.id);
      } else {
        selectedIds.add(tok.id);
      }
      updateWordButtons();
      updateSelectionDisplay();
    };
    
    if (selectedIds.has(tok.id)) {
      btn.classList.add('selected');
    }
    
    els.wordBank.appendChild(btn);
  });
}

function updateWordButtons() {
  const buttons = els.wordBank.querySelectorAll('.word-btn');
  buttons.forEach(btn => {
    const tokenText = btn.textContent;
    const token = currentTokens.find(t => t.text === tokenText);
    
    if (token && selectedIds.has(token.id)) {
      btn.classList.add('selected');
    } else {
      btn.classList.remove('selected');
    }
  });
}

function renderMultipleChoice(puzzle) {
  els.sentenceDisplay.textContent = puzzle.stem;
  
  puzzle.options.forEach((option, i) => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = option;
    
    if (chosenIndex === i) {
      btn.classList.add('selected');
    }
    
    btn.onclick = () => {
      chosenIndex = i;
      renderMultipleChoice(puzzle);
      showFeedback("Choice selected. Press 'Check Answer' to continue.", 'neutral');
    };
    
    els.choices.appendChild(btn);
  });
}

function renderFix(puzzle) {
  els.sentenceDisplay.textContent = puzzle.sentence;
  
  puzzle.choices.forEach((choice, i) => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = choice;
    
    if (chosenIndex === i) {
      btn.classList.add('selected');
    }
    
    btn.onclick = () => {
      chosenIndex = i;
      renderFix(puzzle);
      showFeedback("Choice selected. Press 'Check Answer' to continue.", 'neutral');
    };
    
    els.choices.appendChild(btn);
  });
}

function renderReorder(puzzle) {
  els.sentenceDisplay.textContent = "Build the phrase in the correct order:";
  
  const words = shuffleArray(puzzle.bank.slice());
  
  words.forEach(word => {
    const btn = document.createElement('button');
    btn.className = 'word-btn';
    btn.textContent = word;
    
    btn.onclick = () => {
      builtOrder.push(word);
      updateSelectionDisplay();
    };
    
    els.wordBank.appendChild(btn);
  });
}

function updateSelectionDisplay() {
  const puzzle = currentPuzzle();
  
  if (puzzle.type === 'selectWords') {
    if (selectedIds.size === 0) {
      els.selectionDisplay.className = 'selection-display empty';
      els.selectionDisplay.textContent = 'Click words to select them';
    } else {
      els.selectionDisplay.className = 'selection-display';
      const picked = currentTokens
        .filter(t => selectedIds.has(t.id))
        .sort((a, b) => a.rawIndex - b.rawIndex)
        .map(t => t.text);
      els.selectionDisplay.textContent = `Your selection: ${normalizeTokens(picked)}`;
    }
  } else if (puzzle.type === 'reorder') {
    if (builtOrder.length === 0) {
      els.selectionDisplay.className = 'selection-display empty';
      els.selectionDisplay.textContent = 'Click words to build the phrase';
    } else {
      els.selectionDisplay.className = 'selection-display';
      els.selectionDisplay.textContent = normalizeTokens(builtOrder);
    }
  } else {
    els.selectionDisplay.className = 'selection-display empty';
    els.selectionDisplay.textContent = 'Choose an option above';
  }
}

// ===========================
// CHECKING
// ===========================

function checkAnswer() {
  const puzzle = currentPuzzle();
  
  if (puzzle.type === 'selectWords') {
    checkSelectWords();
  } else if (puzzle.type === 'mc' || puzzle.type === 'fix') {
    checkChoice();
  } else if (puzzle.type === 'reorder') {
    checkReorder();
  }
}

function checkSelectWords() {
  const puzzle = currentPuzzle();
  const picked = currentTokens
    .filter(t => selectedIds.has(t.id))
    .sort((a, b) => a.rawIndex - b.rawIndex)
    .map(t => t.norm);
  
  const pickedMS = multiset(picked);
  
  const correct = (puzzle.accept || []).some(wordSet => {
    const normSet = wordSet.map(w => String(w).toLowerCase());
    return multisetsEqual(pickedMS, multiset(normSet));
  });
  
  if (correct) {
    handleCorrect(puzzle.explain);
  } else {
    handleIncorrect("Not quite! " + currentLevel().mission);
  }
}

function checkChoice() {
  const puzzle = currentPuzzle();
  
  if (chosenIndex === null) {
    showFeedback("Please select an option first!", 'neutral');
    return;
  }
  
  if (chosenIndex === puzzle.answerIndex) {
    handleCorrect(puzzle.explain);
  } else {
    handleIncorrect("Not quite! " + currentLevel().mission);
  }
}

function checkReorder() {
  const puzzle = currentPuzzle();
  const builtNorm = builtOrder.map(w => String(w).toLowerCase());
  const builtStr = builtNorm.join(" ");
  
  const correct = (puzzle.answers || []).some(ans => {
    const ansNorm = ans.map(w => String(w).toLowerCase()).join(" ");
    return ansNorm === builtStr;
  });
  
  if (correct) {
    handleCorrect(puzzle.explain);
  } else {
    handleIncorrect("Not quite! Reset and try again.");
  }
}

function handleCorrect(explanation) {
  const basePoints = 5;
  const streakBonus = Math.min(streak, 10);
  const points = basePoints + streakBonus;
  
  score += points;
  streak += 1;
  completedPuzzles += 1;
  
  updateStats();
  celebrate();
  
  let message = `‚úÖ Correct! +${points} points`;
  if (streakBonus > 0) {
    message += ` (${streakBonus} streak bonus!)`;
  }
  message += ` ${explanation}`;
  
  showFeedback(message, 'correct');
  els.nextBtn.disabled = false;
}

function handleIncorrect(hint) {
  streak = 0;
  updateStats();
  showFeedback(`‚ùå ${hint}`, 'incorrect');
}

// ===========================
// CONTROLS
// ===========================

function reset() {
  renderPuzzle();
}

function showHint() {
  const hint = currentLevel().bridge;
  showFeedback(`üí° Hint: ${hint}`, 'neutral');
}

function skip() {
  showFeedback('‚è≠Ô∏è Skipped (in case of a bug). No points awarded.', 'neutral');
  streak = 0;
  completedPuzzles += 1;
  updateStats();
  setTimeout(next, 1500);
}

function next() {
  const level = currentLevel();
  
  if (puzzleIndex < level.puzzles.length - 1) {
    puzzleIndex++;
    renderPuzzle();
    hideFeedback();
  } else if (levelIndex < LEVELS.length - 1) {
    levelIndex++;
    puzzleIndex = 0;
    renderHeader();
    renderPuzzle();
    showFeedback(`üéä Level ${levelIndex} complete! New skill unlocked!`, 'correct');
  } else {
    showCompletion();
  }
}

function showCompletion() {
  const finalScore = score;
  const code = `SD-${LEVELS.length}-${finalScore}-${Math.floor(Math.random() * 9000 + 1000)}`;
  
  els.gameContainer.innerHTML = `
    <div class="completion-screen">
      <div class="trophy">üèÜ</div>
      <h2>Mission Complete!</h2>
      <p style="font-size: 20px; color: #495057; margin-bottom: 30px;">
        You've unlocked your Spanish Reading Toolkit!
      </p>
      
      <div class="completion-stats">
        <p>‚≠ê Final Score: <strong>${finalScore}</strong></p>
        <p>üî• Best Streak: <strong>${Math.max(streak, 0)}</strong></p>
        <p>üìä Puzzles Completed: <strong>${TOTAL_PUZZLES}/${TOTAL_PUZZLES}</strong></p>
        <p>üéØ Verification Code: <strong>${code}</strong></p>
      </div>
      
      <div class="skills-unlocked">
        <h3>üõ†Ô∏è Skills You've Mastered:</h3>
        <ul>
          <li>Find verbs FAST (the heartbeat of every sentence)</li>
          <li>Identify subjects (who's doing the action)</li>
          <li>Use tag questions to discover pronouns</li>
          <li>Match subjects and verbs correctly</li>
          <li>Align time words with verb tenses</li>
          <li>Apply Spanish adjective placement (noun + adjective)</li>
          <li>Rewrite possession without apostrophe-s (using "de")</li>
        </ul>
      </div>
      
      <p style="margin-top: 30px; font-size: 18px; color: #667eea;">
        <strong>You're now ready for Spanish 101! üéâ</strong>
      </p>
      
      <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px;">
        Play Again
      </button>
    </div>
  `;
}

function closeTutorial() {
  els.tutorialOverlay.style.display = 'none';
}

// ===========================
// EVENT LISTENERS
// ===========================

els.checkBtn.onclick = checkAnswer;
els.nextBtn.onclick = next;
els.resetBtn.onclick = reset;
els.hintBtn.onclick = showHint;
els.skipBtn.onclick = skip;

document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    if (!els.nextBtn.disabled) {
      next();
    } else {
      checkAnswer();
    }
  }
});

// ===========================
// INIT
// ===========================

function init() {
  renderHeader();
  renderPuzzle();
  updateStats();
}

init();
</script>

</body>
</html>
